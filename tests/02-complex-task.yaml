---
apiVersion: arl.infra.io/v1alpha1
kind: Task
metadata:
  name: complex-task
spec:
  sandboxRef: test-sandbox
  timeout: 120s
  steps:
    - name: create_fibonacci_script
      type: FilePatch
      path: /workspace/fib.py
      content: |
        #!/usr/bin/env python3
        import os
        import sys
        
        def fibonacci(n):
            if n <= 1:
                return n
            return fibonacci(n-1) + fibonacci(n-2)
        
        print("Starting complex computation...")
        print(f"Python version: {sys.version}")
        print(f"Working directory: {os.getcwd()}")
        print(f"Environment TEST_VAR: {os.environ.get('TEST_VAR', 'not set')}")
        
        n = 15
        result = fibonacci(n)
        print(f"Fibonacci({n}) = {result}")
        
        with open('/workspace/output.txt', 'w') as f:
            f.write(f"Fibonacci({n}) = {result}\n")
        
        print("Computation completed!")
    
    - name: execute_script
      type: Command
      command: ["python3", "/workspace/fib.py"]
      workDir: /workspace
      env:
        TEST_VAR: "production"
    
    - name: verify_output
      type: Command
      command: ["cat", "/workspace/output.txt"]
    
    - name: list_workspace
      type: Command
      command: ["ls", "-lah", "/workspace"]
    
    - name: check_python_packages
      type: Command
      command: ["python3", "-m", "pip", "list"]
