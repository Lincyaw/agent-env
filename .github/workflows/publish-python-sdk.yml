name: Publish Python SDK

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 0.1.0)"
        required: true
        default: "0.0.0"

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi

    env:
      SDK_DIR: "sdk/python/arl"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Publishing version: ${VERSION}"

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Generate Python SDK
        run: |
          echo "ğŸ”§ Generating Python SDK..."
          make sdk-python

      - name: Update version in pyproject.toml
        run: |
          cd ${SDK_DIR}
          sed -i "s/^version = .*/version = \"${{ steps.version.outputs.version }}\"/" pyproject.toml
          echo "ğŸ“ Updated version to ${{ steps.version.outputs.version }}"
          grep "^version" pyproject.toml

      - name: Verify SDK
        run: |
          if [ ! -f "${SDK_DIR}/pyproject.toml" ]; then
            echo "âŒ pyproject.toml not found"
            exit 1
          fi
          if [ ! -d "${SDK_DIR}/arl" ]; then
            echo "âŒ arl package directory not found"
            exit 1
          fi
          echo "âœ… SDK structure verified"

      - name: Build and publish
        run: |
          cd ${SDK_DIR}
          echo "ğŸ”¨ Building package..."
          uv build --out-dir dist

          echo "ğŸ“¦ Publishing to PyPI..."
          uv publish dist/* --trusted-publishing always

          echo "âœ… Successfully published arl==${{ steps.version.outputs.version }} to PyPI!"
