apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: arl-infra

# Default build configuration
build:
  artifacts:
  - image: arl-operator
    docker:
      dockerfile: Dockerfile.operator
  - image: arl-sidecar
    docker:
      dockerfile: Dockerfile.sidecar
  tagPolicy:
    gitCommit: {}

# Default manifests - using Helm chart
manifests:
  helm:
    releases:
    - name: arl-operator
      chartPath: charts/arl-operator
      namespace: arl-system
      createNamespace: true
      setValues:
        crds.install: true

# Default deploy configuration (for minikube)
deploy:
  kubectl:
    flags:
      apply:
      - --server-side=true
      - --force-conflicts=true

# Profiles for different environments
profiles:
# Profile for standard Kubernetes with registry
- name: k8s
  build:
    artifacts:
    - image: 10.10.10.240/library/arl-operator
      docker:
        dockerfile: Dockerfile.operator
    - image: 10.10.10.240/library/arl-sidecar
      docker:
        dockerfile: Dockerfile.sidecar
    tagPolicy:
      sha256: {}
  manifests:
    helm:
      releases:
      - name: arl-operator
        chartPath: charts/arl-operator
        namespace: arl-system
        createNamespace: true
        setValues:
          crds.install: true
          image.repository: 10.10.10.240/library/arl-operator
          sidecar.image.repository: 10.10.10.240/library/arl-sidecar
  deploy:
    kubectl:
      flags:
        apply:
        - --server-side=true
        - --force-conflicts=true

# Profile for development with auto-sync and rebuild
- name: dev
  activation:
  - command: dev
  build:
    artifacts:
    - image: arl-operator
      docker:
        dockerfile: Dockerfile.operator
      sync:
        manual:
        - src: 'cmd/**/*.go'
          dest: /app
        - src: 'pkg/**/*.go'
          dest: /app
    - image: arl-sidecar
      docker:
        dockerfile: Dockerfile.sidecar
      sync:
        manual:
        - src: 'cmd/sidecar/**/*.go'
          dest: /app
        - src: 'pkg/sidecar/**/*.go'
          dest: /app
  manifests:
    helm:
      releases:
      - name: arl-operator
        chartPath: charts/arl-operator
        namespace: arl-system
        createNamespace: true
        setValues:
          crds.install: true
  deploy:
    kubectl:
      flags:
        apply:
        - --server-side=true
        - --force-conflicts=true

# Profile for deploying samples
- name: with-samples
  manifests:
    helm:
      releases:
      - name: arl-operator
        chartPath: charts/arl-operator
        namespace: arl-system
        createNamespace: true
        setValues:
          crds.install: true
    rawYaml:
    - config/samples/*.yaml
  deploy:
    kubectl:
      flags:
        apply:
        - --server-side=true
        - --force-conflicts=true

# Profile for K8s with samples
- name: k8s-with-samples
  build:
    artifacts:
    - image: 10.10.10.240/library/arl-operator
      docker:
        dockerfile: Dockerfile.operator
    - image: 10.10.10.240/library/arl-sidecar
      docker:
        dockerfile: Dockerfile.sidecar
    tagPolicy:
      sha256: {}
  manifests:
    helm:
      releases:
      - name: arl-operator
        chartPath: charts/arl-operator
        namespace: arl-system
        createNamespace: true
        setValues:
          crds.install: true
          image.repository: 10.10.10.240/library/arl-operator
          sidecar.image.repository: 10.10.10.240/library/arl-sidecar
    rawYaml:
    - config/samples/*.yaml
  deploy:
    kubectl:
      flags:
        apply:
        - --server-side=true
        - --force-conflicts=true
