# ARL-Infra Component Catalog
# This file documents all components in the system with their responsibilities and interfaces

components:
  # ============================================================================
  # Custom Resource Definitions (CRDs)
  # ============================================================================
  - name: warmpool-crd
    type: crd
    paths:
      - api/v1alpha1/warmpool_types.go
      - config/crd/arl.infra.io_warmpools.yaml
    responsibilities:
      - Define WarmPool resource schema
      - Specify validation rules for warm pool configuration
      - Maintain pool of ready-to-use pods
      - Define ToolsSpec for pre-provisioned tools in executor containers
    interfaces:
      inputs:
        - Replicas count
        - Pod template specification
        - Tools specification (images, configmaps, inline)
      outputs:
        - ReadyReplicas count
        - AllocatedReplicas count
        - Conditions

  - name: sandbox-crd
    type: crd
    paths:
      - api/v1alpha1/sandbox_types.go
      - config/crd/arl.infra.io_sandboxes.yaml
    responsibilities:
      - Define Sandbox resource schema
      - Agent isolated workspace bound to a pod
      - Track pod allocation and lifecycle
    interfaces:
      inputs:
        - PoolRef (reference to WarmPool)
        - KeepAlive flag
        - Resource requirements
        - IdleTimeoutSeconds
        - MaxLifetimeSeconds
      outputs:
        - Phase (Pending/Bound/Ready/Failed)
        - PodName
        - PodIP
        - WorkDir
        - LastTaskTime
        - Conditions

  # ============================================================================
  # Controllers
  # ============================================================================
  - name: warmpool-controller
    type: controller
    paths:
      - pkg/controller/warmpool_controller.go
    responsibilities:
      - Reconcile WarmPool resources
      - Maintain desired number of warm pods
      - Track pod readiness and allocation
      - Inject sidecar and executor-agent containers
      - Provision tools via init containers
    interfaces:
      watches:
        - WarmPool
        - Pod
      manages:
        - Pod

  - name: sandbox-controller
    type: controller
    paths:
      - pkg/controller/sandbox_controller.go
    responsibilities:
      - Reconcile Sandbox resources
      - Allocate pods from warm pool
      - Track sandbox lifecycle phases
    interfaces:
      watches:
        - Sandbox
        - WarmPool
        - Pod
      manages:
        - Sandbox status

  # ============================================================================
  # Gateway
  # ============================================================================
  - name: gateway
    type: gateway
    paths:
      - cmd/gateway/main.go
      - pkg/gateway/gateway.go
      - pkg/gateway/router.go
      - pkg/gateway/types.go
      - pkg/gateway/history.go
      - pkg/gateway/ws_shell.go
    responsibilities:
      - Provide REST API for session and execution management
      - Create/delete sessions (sandbox lifecycle)
      - Execute steps via direct gRPC to sidecar
      - Manage execution history and trajectory export
      - WebSocket proxy for interactive shell
    interfaces:
      exposes:
        - REST API (POST/GET/DELETE /v1/sessions, /v1/pools)
        - WebSocket /v1/sessions/{id}/shell
      calls:
        - Kubernetes API (Sandbox/WarmPool CRDs)
        - Sidecar gRPC (AgentService)
    config:
      default_port: 8080

  # ============================================================================
  # Webhooks
  # ============================================================================
  - name: sandbox-webhook
    type: webhook
    paths:
      - pkg/webhook/sandbox_validator.go
    responsibilities:
      - Validate Sandbox resources on create/update
      - Ensure PoolRef exists

  - name: warmpool-webhook
    type: webhook
    paths:
      - pkg/webhook/warmpool_validator.go
    responsibilities:
      - Validate WarmPool resources on create/update
      - Ensure name is valid DNS label

  # ============================================================================
  # Operator
  # ============================================================================
  - name: operator
    type: operator
    paths:
      - cmd/operator/main.go
    responsibilities:
      - Bootstrap Kubernetes controller manager
      - Register WarmPool and Sandbox controllers
      - Register webhooks
      - Serve health and metrics endpoints
      - Initialize image-locality scheduler
    config:
      default_namespace: arl-system
      health_probe_port: 8081
      metrics_port: 8080

  # ============================================================================
  # Sidecar
  # ============================================================================
  - name: sidecar
    type: sidecar
    paths:
      - cmd/sidecar/main.go
      - pkg/sidecar/service.go
      - pkg/sidecar/grpc_server.go
      - pkg/sidecar/executor_client.go
    responsibilities:
      - Run as sidecar in warm pool pods
      - Provide gRPC API for file operations and command execution
      - Forward commands to executor-agent via Unix socket
      - Manage interactive shell sessions
      - Auto-snapshot workspace after each step (git-based)
    interfaces:
      exposes:
        - gRPC AgentService
      calls:
        - Executor Agent (Unix socket)
      grpc_methods:
        - UpdateFiles
        - Execute
        - SignalProcess
        - Reset
        - InteractiveShell
    config:
      default_port: 50051
      workspace_dir: /workspace

  # ============================================================================
  # Executor Agent
  # ============================================================================
  - name: executor-agent
    type: agent
    paths:
      - cmd/executor-agent/main.go
      - pkg/execagent/agent.go
      - pkg/execagent/protocol.go
    responsibilities:
      - Run inside executor container
      - Execute commands received from sidecar via Unix socket
      - Provide isolated execution environment with executor-specific tools

  # ============================================================================
  # Scheduler
  # ============================================================================
  - name: image-scheduler
    type: scheduler
    paths:
      - pkg/scheduler/image_scheduler.go
      - pkg/scheduler/rendezvous.go
    responsibilities:
      - Image-locality aware pod scheduling
      - Use rendezvous hashing for consistent node selection
      - Prefer nodes that already have required container images

  # ============================================================================
  # Protocol Buffers
  # ============================================================================
  - name: agent-proto
    type: proto
    paths:
      - proto/agent.proto
    responsibilities:
      - Define gRPC service interface for sidecar
      - Define message types for file/process operations
    interfaces:
      defines:
        - AgentService
        - FileRequest/FileResponse
        - ExecRequest/ExecLog
        - SignalRequest/SignalResponse
        - ResetRequest/ResetResponse
        - ShellInput/ShellOutput

  - name: proto-go-generated
    type: generated
    paths:
      - pkg/pb/agent.pb.go
      - pkg/pb/agent_grpc.pb.go
    responsibilities:
      - Go implementation of protobuf messages
      - Go gRPC client and server stubs

  # ============================================================================
  # Python SDK
  # ============================================================================
  - name: python-sdk
    type: sdk
    paths:
      - sdk/python/arl/
    responsibilities:
      - Provide Python client for ARL via Gateway API
      - High-level SandboxSession for session management
      - GatewayClient for REST API communication
      - Tool invocation (list_tools, call_tool)
      - Trajectory export for RL/SFT training
    interfaces:
      depends_on:
        - Gateway REST API
      provides:
        - SandboxSession
        - GatewayClient
        - WarmPoolManager
        - InteractiveShellClient

  # ============================================================================
  # Helm Charts
  # ============================================================================
  - name: helm-chart
    type: config
    paths:
      - charts/arl-operator/
    responsibilities:
      - Kubernetes deployment configuration
      - Service accounts and RBAC
      - CRD installation
      - Gateway deployment

  # ============================================================================
  # Configuration
  # ============================================================================
  - name: crd-manifests
    type: config
    paths:
      - config/crd/
    responsibilities:
      - Generated CRD YAML manifests
      - OpenAPI validation schemas

  - name: sample-resources
    type: config
    paths:
      - config/samples/
    responsibilities:
      - Example resource configurations
      - Quick start templates
