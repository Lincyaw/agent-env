# ARL-Infra Dependency Graph
# This file documents technical and logical dependencies between components

# Dependency Types:
#   - import: Go package import
#   - watch: Kubernetes watch on resource type
#   - grpc: gRPC client-server communication
#   - references: Logical reference (e.g., field referencing another CRD)
#   - generates: Code generation output
#   - implements: Implements an interface definition
#   - includes: Includes/bundles other resources
#   - deploys: Deploys/installs a component
#   - http: HTTP client-server communication
#   - unix_socket: Unix domain socket communication

dependencies:
  # ============================================================================
  # CRD Dependencies
  # ============================================================================
  - from: sandbox-crd
    to: warmpool-crd
    type: references
    description: SandboxSpec.PoolRef references WarmPool by name

  # ============================================================================
  # Controller Dependencies
  # ============================================================================
  # WarmPool Controller
  - from: warmpool-controller
    to: warmpool-crd
    type: import
    description: Uses WarmPool types for reconciliation

  - from: warmpool-controller
    to: warmpool-crd
    type: watch
    description: Watches WarmPool resources for changes

  - from: warmpool-controller
    to: image-scheduler
    type: import
    description: Uses image-locality scheduler for pod placement

  # Sandbox Controller
  - from: sandbox-controller
    to: sandbox-crd
    type: import
    description: Uses Sandbox types for reconciliation

  - from: sandbox-controller
    to: sandbox-crd
    type: watch
    description: Watches Sandbox resources for changes

  - from: sandbox-controller
    to: warmpool-crd
    type: import
    description: Reads WarmPool to allocate pods

  - from: sandbox-controller
    to: warmpool-crd
    type: watch
    description: Watches WarmPool for available pods

  # ============================================================================
  # Gateway Dependencies
  # ============================================================================
  - from: gateway
    to: sandbox-crd
    type: import
    description: Creates/deletes Sandbox CRDs for session management

  - from: gateway
    to: warmpool-crd
    type: import
    description: Creates/reads/deletes WarmPool CRDs for pool management

  - from: gateway
    to: sidecar
    type: grpc
    description: Calls sidecar AgentService to execute steps

  - from: gateway
    to: proto-go-generated
    type: import
    description: Uses generated gRPC client stubs

  # ============================================================================
  # Webhook Dependencies
  # ============================================================================
  - from: sandbox-webhook
    to: sandbox-crd
    type: import
    description: Validates Sandbox resources

  - from: sandbox-webhook
    to: warmpool-crd
    type: import
    description: Validates PoolRef exists

  - from: warmpool-webhook
    to: warmpool-crd
    type: import
    description: Validates WarmPool resources

  # ============================================================================
  # Operator Dependencies
  # ============================================================================
  - from: operator
    to: warmpool-controller
    type: import
    description: Registers WarmPool controller

  - from: operator
    to: sandbox-controller
    type: import
    description: Registers Sandbox controller

  - from: operator
    to: sandbox-webhook
    type: import
    description: Registers Sandbox webhook

  - from: operator
    to: warmpool-webhook
    type: import
    description: Registers WarmPool webhook

  - from: operator
    to: image-scheduler
    type: import
    description: Initializes image-locality scheduler

  # ============================================================================
  # Sidecar Dependencies
  # ============================================================================
  - from: sidecar
    to: proto-go-generated
    type: import
    description: Implements AgentService gRPC server

  - from: sidecar
    to: agent-proto
    type: implements
    description: Implements AgentService interface

  - from: sidecar
    to: executor-agent
    type: unix_socket
    description: Forwards command execution to executor-agent

  # ============================================================================
  # Executor Agent Dependencies
  # ============================================================================
  - from: executor-agent
    to: sidecar
    type: unix_socket
    description: Receives commands from sidecar via shared Unix socket

  # ============================================================================
  # Code Generation Dependencies
  # ============================================================================
  - from: proto-go-generated
    to: agent-proto
    type: generates
    description: Generated from proto/agent.proto via protoc

  - from: crd-manifests
    to: warmpool-crd
    type: generates
    description: Generated from Go types via controller-gen

  - from: crd-manifests
    to: sandbox-crd
    type: generates
    description: Generated from Go types via controller-gen

  # ============================================================================
  # SDK Dependencies
  # ============================================================================
  - from: python-sdk
    to: gateway
    type: http
    description: SDK communicates with Gateway REST API

  # ============================================================================
  # Deployment Dependencies
  # ============================================================================
  - from: helm-chart
    to: crd-manifests
    type: includes
    description: Helm chart installs CRD manifests

  - from: helm-chart
    to: operator
    type: deploys
    description: Helm chart deploys operator

  - from: helm-chart
    to: gateway
    type: deploys
    description: Helm chart deploys gateway
